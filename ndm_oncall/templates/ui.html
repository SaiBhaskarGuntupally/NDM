<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Incoming Call Workspace</title>
    <link rel="stylesheet" href="/static/ui.css" />
  </head>
  <body>
    <div class="ndm-root">
      <div class="ndm-sparkle-layer" aria-hidden="true"></div>
      <div class="ndm-vignette" aria-hidden="true"></div>
      <div class="ndm-shell">
        <main class="app-panel">
          <header class="app-header">
            <div class="ndm-header-left">
              <div class="ndm-signal-badge"></div>
              <div class="ndm-title-block">
                <div class="ndm-title">NDM</div>
                <div class="ndm-subtitle">NumberDorikindi Machaa</div>
                <div class="ndm-tagline">Local Call Intelligence</div>
              </div>
            </div>
            <div class="status-pill">
              <button id="machaaModeBtn" class="machaa-mode-btn" type="button">
                <span class="machaa-label">‚ö° Machaa Mode</span>
              </button>
              <div
                id="machaaModeMsg"
                class="machaa-mode-msg"
                style="display: none"
              >
                Please allow popups to use Machaa Mode.
                <button class="machaa-mode-retry" type="button">Retry</button>
              </div>
            </div>
            <script>
              (function () {
                var mainRef = null;
                var portRef = null;

                function maximizeOnScreen(winRef, screen) {
                  try {
                    winRef.moveTo(screen.availLeft, screen.availTop);
                    winRef.resizeTo(screen.availWidth, screen.availHeight);
                  } catch (e) {
                    console.warn("[NDM] moveTo/resizeTo blocked:", e);
                  }
                }

                function openAndPlace(screens) {
                  var s1 = screens[0];
                  var s2 = screens.length > 1 ? screens[1] : null;
                  var mainScreen = s1;
                  var portScreen = s2 || s1;

                  // Open /ui on display 1
                  if (mainRef && !mainRef.closed) {
                    mainRef.focus();
                    maximizeOnScreen(mainRef, mainScreen);
                  } else {
                    var mf =
                      "popup=yes,left=" +
                      mainScreen.availLeft +
                      ",top=" +
                      mainScreen.availTop +
                      ",width=" +
                      mainScreen.availWidth +
                      ",height=" +
                      mainScreen.availHeight;
                    // Open main window and mark as machaa role
                    mainRef = window.open(
                      "/ui?machaa=1&role=main",
                      "NDM_MACHA_MODE_MAIN",
                      mf,
                    );
                    if (mainRef) {
                      // Immediately try to maximize synchronously
                      try {
                        maximizeOnScreen(mainRef, mainScreen);
                        try {
                          mainRef.focus();
                        } catch (e) {}
                        console.log(
                          "[NDM] main opened, attempted immediate maximize",
                        );
                        // Quick fullscreen attempt as part of user gesture (may or may not be allowed)
                        try {
                          if (
                            mainRef.document &&
                            mainRef.document.documentElement &&
                            mainRef.document.documentElement.requestFullscreen
                          ) {
                            mainRef.document.documentElement
                              .requestFullscreen()
                              .then(function () {
                                console.log(
                                  "[NDM] main window fullscreen success (sync)",
                                );
                              })
                              .catch(function (err) {
                                console.warn(
                                  "[NDM] main window fullscreen failed (sync):",
                                  err,
                                );
                              });
                          }
                        } catch (e) {
                          console.warn(
                            "[NDM] main fullscreen attempt threw:",
                            e,
                          );
                        }
                      } catch (e) {
                        console.warn("[NDM] main immediate maximize threw:", e);
                      }

                      // Re-apply maximize and try fullscreen again on load; also schedule retries
                      mainRef.addEventListener("load", function () {
                        maximizeOnScreen(mainRef, mainScreen);
                        try {
                          mainRef.focus();
                        } catch (e) {}
                        console.log("[NDM] main load: maximize attempted");
                        try {
                          if (
                            mainRef.document &&
                            mainRef.document.documentElement &&
                            mainRef.document.documentElement.requestFullscreen
                          ) {
                            mainRef.document.documentElement
                              .requestFullscreen()
                              .then(function () {
                                console.log(
                                  "[NDM] main window fullscreen success (onload)",
                                );
                              })
                              .catch(function (err) {
                                console.warn(
                                  "[NDM] main window fullscreen failed (onload):",
                                  err,
                                );
                              });
                          }
                        } catch (err) {
                          console.warn(
                            "[NDM] main fullscreen onload threw:",
                            err,
                          );
                        }
                      });

                      // Retry maximize a few times after opening (some window managers take time)
                      [100, 400, 1200].forEach(function (d) {
                        setTimeout(function () {
                          try {
                            maximizeOnScreen(mainRef, mainScreen);
                          } catch (e) {}
                        }, d);
                      });

                      // After retries, log current geometry
                      setTimeout(function () {
                        try {
                          console.log("[NDM] main geometry", {
                            outerWidth: mainRef.outerWidth,
                            outerHeight: mainRef.outerHeight,
                            screenX: mainRef.screenX,
                            screenY: mainRef.screenY,
                          });
                        } catch (e) {}
                      }, 1400);
                    }
                  }

                  // Open portrait on display 2
                  if (portRef && !portRef.closed) {
                    portRef.focus();
                    maximizeOnScreen(portRef, portScreen);
                  } else {
                    var pf =
                      "popup=yes,left=" +
                      portScreen.availLeft +
                      ",top=" +
                      portScreen.availTop +
                      ",width=" +
                      portScreen.availWidth +
                      ",height=" +
                      portScreen.availHeight;
                    // Open portrait window and mark as machaa role
                    portRef = window.open(
                      "/machaa-mode/portrait?machaa=1&role=portrait",
                      "NDM_MACHA_MODE_PORTRAIT",
                      pf,
                    );
                    if (portRef) {
                      try {
                        // immediate maximize + focus
                        maximizeOnScreen(portRef, portScreen);
                        try {
                          portRef.focus();
                        } catch (e) {}
                        console.log(
                          "[NDM] portrait opened, attempted immediate maximize",
                        );

                        // Quick fullscreen attempt as part of gesture
                        try {
                          if (
                            portRef.document &&
                            portRef.document.documentElement &&
                            portRef.document.documentElement.requestFullscreen
                          ) {
                            portRef.document.documentElement
                              .requestFullscreen()
                              .then(function () {
                                console.log(
                                  "[NDM] portrait fullscreen success (sync)",
                                );
                              })
                              .catch(function (err) {
                                console.warn(
                                  "[NDM] portrait fullscreen failed (sync):",
                                  err,
                                );
                              });
                          }
                        } catch (e) {
                          console.warn(
                            "[NDM] portrait fullscreen attempt threw:",
                            e,
                          );
                        }
                      } catch (e) {
                        console.warn(
                          "[NDM] portrait immediate maximize threw:",
                          e,
                        );
                      }

                      portRef.addEventListener("load", function () {
                        maximizeOnScreen(portRef, portScreen);
                        try {
                          portRef.focus();
                        } catch (e) {}
                        console.log("[NDM] portrait load: maximize attempted");
                        try {
                          if (
                            portRef.document &&
                            portRef.document.documentElement &&
                            portRef.document.documentElement.requestFullscreen
                          ) {
                            portRef.document.documentElement
                              .requestFullscreen()
                              .then(function () {
                                console.log(
                                  "[NDM] portrait fullscreen success (onload)",
                                );
                              })
                              .catch(function (err) {
                                console.warn(
                                  "[NDM] portrait fullscreen failed (onload):",
                                  err,
                                );
                              });
                          }
                        } catch (err) {
                          console.warn(
                            "[NDM] portrait fullscreen onload threw:",
                            err,
                          );
                        }
                      });

                      [120, 420, 1300].forEach(function (d) {
                        setTimeout(function () {
                          try {
                            maximizeOnScreen(portRef, portScreen);
                          } catch (e) {}
                        }, d);
                      });

                      setTimeout(function () {
                        try {
                          console.log("[NDM] portrait geometry", {
                            outerWidth: portRef.outerWidth,
                            outerHeight: portRef.outerHeight,
                            screenX: portRef.screenX,
                            screenY: portRef.screenY,
                          });
                        } catch (e) {}
                      }, 1500);
                    }
                  }

                  var blocked = !mainRef || !portRef;
                  var msg = document.getElementById("machaaModeMsg");
                  if (msg) msg.style.display = blocked ? "flex" : "none";
                }

                function go() {
                  console.log("[NDM] Machaa Mode clicked");
                  // Try the multi-screen Window Management API first
                  if ("getScreenDetails" in window) {
                    window
                      .getScreenDetails()
                      .then(function (details) {
                        var screens = Array.from(details.screens).sort(
                          function (a, b) {
                            return a.availLeft - b.availLeft;
                          },
                        );
                        console.log(
                          "[NDM] Detected " + screens.length + " screen(s)",
                        );
                        openAndPlace(screens);
                      })
                      .catch(function (err) {
                        console.warn(
                          "[NDM] Screen details denied, using fallback:",
                          err,
                        );
                        openAndPlace([screen]);
                      });
                  } else {
                    // Fallback: use hardcoded positions
                    var fakeS1 = {
                      availLeft: 0,
                      availTop: 0,
                      availWidth: screen.availWidth,
                      availHeight: screen.availHeight,
                    };
                    var fakeS2 = {
                      availLeft: screen.width,
                      availTop: 0,
                      availWidth: 1080,
                      availHeight: 1920,
                    };
                    openAndPlace([fakeS1, fakeS2]);
                  }
                }

                document
                  .getElementById("machaaModeBtn")
                  .addEventListener("click", go);
                var retry = document.querySelector(".machaa-mode-retry");
                if (retry) retry.addEventListener("click", go);
              })();
            </script>
          </header>

          <div class="app-content">
            <section class="col-left">
              <div class="card caller-card" id="callerInfo">
                <div class="caller-dash">‚Äî</div>
                <div class="caller-number">‚Äî</div>
                <div class="caller-subtitle">Machaa, number dorikindi.</div>
                <div class="caller-meta" id="callerMeta">‚Äî</div>
              </div>

              <div class="card">
                <div class="section-title gold-title">
                  Recent Dorikina Numbers
                </div>
                <div class="scroll-area" id="recentCallsList">
                  <div id="recentCalls" class="empty-text">
                    Evaru call cheyyaledu<br />
                    machaa...
                  </div>
                </div>
              </div>

              <div class="card notes-card">
                <div class="section-title with-icon gold-title">
                  <span class="icon-note" aria-hidden="true">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <rect
                        x="5"
                        y="4"
                        width="14"
                        height="16"
                        rx="2"
                        fill="none"
                        stroke="#FFC83D"
                        stroke-width="2"
                      />
                      <path
                        d="M8 8h8M8 12h8M8 16h6"
                        stroke="#FFC83D"
                        stroke-width="2"
                        stroke-linecap="round"
                      />
                    </svg>
                  </span>
                  <span>Machaa Notes</span>
                </div>
                <div id="notes"></div>
                <textarea id="noteInput" placeholder="Note etu bro?"></textarea>
                <div class="note-actions">
                  <button id="saveNote" class="note-btn">
                    <span class="icon-check" aria-hidden="true">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <circle
                          cx="12"
                          cy="12"
                          r="9"
                          fill="none"
                          stroke="#3AFFC3"
                          stroke-width="2"
                        />
                        <path
                          d="M8.5 12.5l2.5 2.5 4.8-5"
                          fill="none"
                          stroke="#3AFFC3"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </span>
                    Note Save Aindi
                  </button>
                  <span class="kbd-pill">(Ctrl+Enter)</span>
                </div>
              </div>
            </section>

            <section class="col-right">
              <div class="tabs">
                <button class="tab active" data-tab="emails">
                  Emails Dorikayi
                </button>
                <button class="tab" data-tab="jd">JD Pin Chesam</button>
                <button class="tab" data-tab="resume">Resume Match</button>
              </div>

              <div class="tab-content active" id="tab-emails">
                <div class="card list-card">
                  <div class="section-title row-title">
                    <span>Recent Dorikina Numbers</span>
                    <span class="chevron" aria-hidden="true">
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path
                          d="M9 6l6 6-6 6"
                          fill="none"
                          stroke="rgba(245,247,250,0.6)"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </span>
                  </div>
                  <div class="scroll-area" id="emailsRecentList">
                    <div id="emailsRecent"></div>
                  </div>
                </div>

                <div class="card list-card">
                  <div class="section-title">Related Emails</div>
                  <div class="scroll-area" id="emailsRelatedList">
                    <div id="emailsRelated"></div>
                  </div>
                </div>
              </div>

              <div class="tab-content" id="tab-jd">
                <div class="card">
                  <div class="section-title">JD Pin Chesam</div>
                  <div class="text-block" id="jdText">No JD pinned.</div>
                </div>
              </div>

              <div class="tab-content" id="tab-resume">
                <div class="card">
                  <div class="section-title">Resume Match</div>
                  <div class="text-block" id="resumeMatch">
                    No resume match yet.
                  </div>
                </div>
              </div>
            </section>
          </div>

          <div id="toast" class="ndm-toast hidden">
            <div class="toast-left">
              <!-- Removed image: no logo shown on top -->
            </div>
            <div class="toast-text">
              <div>Ring ochindi machaa üëÄ</div>
              <div class="toast-sub">
                +1-205-240-3989. Gmail lo dorikindi ‚úâÔ∏è
              </div>
            </div>
            <button id="toastClose" class="toast-close" aria-label="Close">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 6l12 12M18 6l-12 12"
                  fill="none"
                  stroke="rgba(245,247,250,0.7)"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
            </button>
          </div>

          <div class="header-actions hidden">
            <div class="status" id="status">Waiting for calls‚Ä¶</div>
            <button id="stopRecording" disabled>Stop Recording</button>
          </div>
        </main>
      </div>
    </div>

    <script>
      window.__PROFILE_API_BASE__ = "";
    </script>
    <!-- INJECT_PROFILE_JS -->
    <script>
      console.log(
        "[NDM] ProfileStore loaded:",
        typeof window.ProfileStore !== "undefined",
        window.ProfileStore,
      );

      // If this window was opened by Machaa Mode, attempt a best-effort fullscreen
      (function () {
        try {
          const params = new URLSearchParams(location.search);
          if (params.get("machaa") === "1") {
            const role = params.get("role") || "unknown";
            console.log("[NDM] Machaa child window load, role=", role);
            // Try to request fullscreen - note: many browsers will block fullscreen unless the request is part
            // of the original user gesture. We still attempt it as a best-effort: it will succeed in some cases
            // and fail in others. Regardless, we also maximize via moveTo/resizeTo as a reliable fallback.
            try {
              if (document.documentElement.requestFullscreen) {
                document.documentElement
                  .requestFullscreen()
                  .then(() => {
                    console.log("[NDM] child fullscreen success");
                  })
                  .catch((err) => {
                    console.warn("[NDM] child fullscreen failed:", err);
                    try {
                      window.moveTo(0, 0);
                      window.resizeTo(screen.availWidth, screen.availHeight);
                    } catch (e) {}
                  });
              } else {
                try {
                  window.moveTo(0, 0);
                  window.resizeTo(screen.availWidth, screen.availHeight);
                } catch (e) {}
              }
            } catch (e) {
              console.warn("[NDM] child fullscreen attempt threw:", e);
            }
          }
        } catch (e) {}
      })();
    </script>
    <script src="/static/ui.js"></script>
  </body>
</html>
